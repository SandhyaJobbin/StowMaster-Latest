<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Fulfillment Center Training Game</title>
    <style>
        /* --- START OF ORIGINAL CSS CODE --- */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap');

        :root {
            --primary-color: #FF9900;
            --secondary-color: #232F3E;
            --background-gradient: linear-gradient(135deg, #232F3E 0%, #FF9900 100%);
            --text-color: #333;
            --card-bg: white;
            --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        /* Reset & base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body,
        html {
            height: 100%;
            font-family: 'Poppins', sans-serif;
            background: var(--background-gradient);
            color: var(--text-color);
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        /* Welcome Screen and Admin Login Screen */
        #welcome-screen,
        #admin-login-screen {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 20px;
            user-select: none;
            text-align: center;
        }

        #welcome-logo {
            font-size: 5em;
            margin-bottom: 10px;
            animation: bounce 1s infinite alternate;
        }

        #welcome-title {
            font-size: clamp(2em, 5vw, 3.5em);
            font-weight: 900;
            letter-spacing: 3px;
            margin-bottom: 35px;
            text-transform: uppercase;
        }

        @keyframes bounce {
            from {
                transform: translateY(0);
            }

            to {
                transform: translateY(-10px);
            }
        }

        #user-name-input,
        #user-email-input,
        #admin-username-input,
        #admin-password-input {
            border-radius: 25px;
            border: none;
            padding: 15px 25px;
            font-size: 1.2em;
            width: 280px;
            max-width: 90vw;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            color: var(--secondary-color);
            font-weight: bold;
            outline: none;
            text-align: center;
            transition: box-shadow 0.3s ease;
        }

        #user-name-input:focus,
        #user-email-input:focus,
        #admin-username-input:focus,
        #admin-password-input:focus {
            box-shadow: 0 0 0 4px rgba(255, 153, 0, 0.5);
        }

        #submit-name-btn,
        #admin-login-btn,
        .admin-action-btn {
            background: var(--secondary-color);
            color: var(--primary-color);
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 25px;
            font-weight: 900;
            letter-spacing: 2px;
            cursor: pointer;
            box-shadow: 0 6px 30px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            margin-top: 5px;
        }

        #submit-name-btn:hover,
        #admin-login-btn:hover,
        .admin-action-btn:hover {
            background: var(--primary-color);
            color: var(--secondary-color);
            transform: translateY(-3px);
            box-shadow: 0 10px 40px rgba(255, 153, 0, 0.6);
        }

        #admin-back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s ease;
        }

        #admin-back-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        /* Main game container hidden initially */
        #game-container {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            box-sizing: border-box;
            animation: fadeIn 0.8s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Header styles */
        .header {
            text-align: center;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            border: 3px solid var(--primary-color);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50px;
            left: -50px;
            width: 150px;
            height: 150px;
            background: rgba(255, 153, 0, 0.1);
            border-radius: 50%;
            transform: rotate(25deg);
        }

        .header h1 {
            color: var(--secondary-color);
            font-size: clamp(1.8em, 4vw, 2.8em);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-weight: 900;
        }

        .header p {
            color: #666;
            font-size: clamp(1em, 2vw, 1.2em);
            position: relative;
        }

        .timer-container {
            text-align: center;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 10px 20px;
            border-radius: 25px;
            border: 2px solid var(--primary-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .global-timer {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--secondary-color);
            user-select: none;
        }

        /* Game header */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .game-title {
            font-size: clamp(1.5em, 3vw, 1.8em);
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }

        #leaderboard-button {
            background: var(--primary-color);
            border: none;
            color: white;
            font-weight: 700;
            font-size: 1em;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 153, 0, 0.7);
            transition: all 0.3s ease;
        }

        #leaderboard-button:hover {
            background: #e6850e;
            color: #fff;
            transform: scale(1.05);
        }

        /* Stats dashboard */
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .stat-number {
            font-size: clamp(1.8em, 4vw, 2.5em);
            font-weight: bold;
            color: var(--secondary-color);
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
            font-weight: 600;
        }

        /* Game area */
        .game-area {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
        }

        /* Difficulty selector */
        .difficulty-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .difficulty-btn {
            padding: 10px 20px;
            border: 2px solid var(--primary-color);
            background: white;
            color: var(--primary-color);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            user-select: none;
            font-size: 0.9em;
        }

        .difficulty-btn.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 10px rgba(255, 153, 0, 0.4);
            transform: scale(1.05);
        }

        /* Instruction panel */
        .instruction-panel {
            background: linear-gradient(135deg, #FFF8E1 0%, #FFECB3 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 5px solid var(--primary-color);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            user-select: none;
            color: #666;
        }

        .instruction-panel h3 {
            color: #E65100;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        ul li {
            margin-bottom: 7px;
            font-weight: 500;
            line-height: 1.5;
        }

        /* Stowing area */
        .stowing-area {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin-bottom: 25px;
        }

        .conveyor-belt {
            background: linear-gradient(90deg, #444 0%, #666 50%, #444 100%);
            height: 120px;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            border: 3px solid #333;
        }

        .product-item {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            color: #333;
            min-width: 200px;
            animation-name: moveConveyor;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }

        @keyframes moveConveyor {
            from {
                left: -250px;
            }

            to {
                left: 100%;
            }
        }

        .product-emoji {
            font-size: 2em;
        }

        .product-info {
            flex: 1;
        }

        .product-name {
            font-size: 1.1em;
            margin-bottom: 3px;
            user-select: none;
        }

        .product-id {
            font-size: 0.8em;
            color: #666;
            user-select: none;
        }

        /* Storage bins */
        .pod-container {
            display: flex;
            justify-content: center;
        }

        .pod {
            display: grid;
            grid-template-columns: repeat(4, 90px);
            grid-template-rows: repeat(6, 70px);
            gap: 3px;
            background: var(--secondary-color);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            user-select: none;
        }

        .bin {
            background: #FFD700;
            border: 3px solid #FFC107;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border-radius: 8px;
            color: #333;
        }

        .bin:hover {
            background: #e6850e;
            transform: scale(1.05);
            border-color: var(--primary-color);
        }

        .bin.occupied {
            background: #E3F2FD;
            border-color: #2196F3;
            color: #1976D2;
        }

        .bin.target {
            background: #FFD700;
            border-color: #FFC107;
            color: #333;
            animation: targetPulse 1.5s ease-in-out infinite;
            box-shadow: 0 0 15px #FFD700;
        }

        .bin.correct {
            background: #E8F5E8;
            border-color: #4CAF50;
            color: #2E7D32;
            animation: successPulse 0.6s ease;
        }

        .bin.incorrect {
            background: #FFEBEE;
            border-color: #f44336;
            color: #C62828;
            animation: errorShake 0.6s ease;
        }

        @keyframes targetPulse {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 15px #FFD700;
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 25px #FFD700;
            }
        }

        @keyframes successPulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.15);
            }

            100% {
                transform: scale(1);
            }
        }

        @keyframes errorShake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-8px);
            }

            75% {
                transform: translateX(8px);
            }
        }

        .bin-label {
            font-size: 0.8em;
            font-weight: bold;
            user-select: none;
        }

        .bin-content {
            font-size: 1.2em;
            margin-top: 2px;
        }

        /* Controls buttons */
        .game-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            user-select: none;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 6px 25px rgba(255, 153, 0, 0.8);
            transition: all 0.3s ease;
        }

        #start-btn {
            background: #4CAF50;
            color: white;
        }

        #start-btn:hover {
            background: #388E3C;
            transform: translateY(-2px);
        }

        #pause-btn {
            background: #6c757d;
            color: white;
        }

        #pause-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        #demo-btn {
            background: var(--primary-color);
            color: white;
        }

        #demo-btn:hover {
            background: #e68500;
            transform: scale(1.05);
        }

        /* Challenge Timer for display when challenges are relevant (e.g. demo) */
        .challenge-timer {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--secondary-color);
            background: #f8f9fa;
            padding: 10px 20px;
            border-radius: 25px;
            border: 2px solid var(--primary-color);
            text-align: center;
            user-select: none;
        }

        /* Combo display */
        #combo-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #4CAF50;
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 2em;
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
        }

        /* Achievement popup */
        .achievement-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            transform: translateX(100%);
            transition: transform 0.4s ease;
            z-index: 1000;
            max-width: 300px;
        }

        .achievement-popup.show {
            transform: translateX(0);
        }

        .achievement-popup h4 {
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .bin.target-error {
            background: #FF5252;
            border-color: #D32F2F;
            animation: none;
            box-shadow: 0 0 15px #FF5252;
        }

        /* Admin Dashboard (Leaderboard styling is shared) */
        #admin-dashboard {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            box-sizing: border-box;
            background: var(--background-gradient);
        }

        .dashboard-header {
            text-align: center;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            border: 3px solid var(--secondary-color);
        }

        .dashboard-header h2 {
            color: var(--secondary-color);
            font-size: clamp(2em, 4vw, 3em);
            font-weight: 900;
        }

        /* Leaderboard */
        #leaderboard-screen,
        #admin-leaderboard-container {
            /* Shared styles for the full screen leaderboard and admin dashboard */
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(12px);
            box-shadow: 0 15px 40px rgba(255, 153, 0, 0.7);
            border-radius: 20px;
            padding: 30px 40px;
            max-width: 900px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            z-index: 1100;
            color: var(--secondary-color);
        }

        #admin-leaderboard-container {
            /* Styles specific to the embedded admin view */
            margin: 20px auto;
        }

        #leaderboard-screen {
            /* Styles specific to the modal/fixed user view */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }

        #leaderboard-table,
        #admin-leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1em;
        }

        #leaderboard-table th,
        #leaderboard-table td,
        #admin-leaderboard-table th,
        #admin-leaderboard-table td {
            padding: 12px 10px;
            border-bottom: 2px solid var(--primary-color);
            text-align: center;
        }

        #leaderboard-table th,
        #admin-leaderboard-table th {
            background: var(--primary-color);
            color: white;
            text-transform: uppercase;
            font-weight: bold;
        }

        #leaderboard-table tr:nth-child(even),
        #admin-leaderboard-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        #leaderboard-table tr:hover,
        #admin-leaderboard-table tr:hover {
            background: #FFF3E0;
            cursor: default;
        }

        /* New styles for top 3 ranks */
        .rank-1st td {
            background-color: #FFD700;
            color: #333;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.8);
        }

        .rank-2nd td {
            background-color: #C0C0C0;
            color: #333;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(192, 192, 192, 0.8);
        }

        .rank-3rd td {
            background-color: #CD7F32;
            color: white;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(205, 127, 50, 0.8);
        }

        #leaderboard-back-btn,
        #download-report-btn {
            margin-top: 15px;
            /* Adjusted margin */
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
            box-shadow: 0 6px 25px rgba(255, 153, 0, 0.8);
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        /* Admin download button styling (using existing styles) */
        #admin-download-report-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
            box-shadow: 0 6px 25px rgba(76, 175, 80, 0.8);
            transition: all 0.3s ease;
            text-transform: uppercase;
            margin-top: 20px;
        }

        #admin-download-report-btn:hover {
            background: #388E3C;
            transform: translateY(-3px);
        }

        #admin-logout-btn {
            background: #f44336;
            color: white;
            margin-top: 15px;
        }

        #admin-logout-btn:hover {
            background: #D32F2F;
        }

        #leaderboard-back-btn:hover {
            background: #e6850e;
            transform: translateY(-3px);
        }

        .leaderboard-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
        }

        .pagination-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 2em;
            cursor: pointer;
            padding: 5px 10px;
            transition: transform 0.2s ease;
        }

        .pagination-btn:hover {
            transform: scale(1.2);
        }

        .pagination-btn:disabled {
            color: #ccc;
            cursor: not-allowed;
        }

        #total-users-count,
        #admin-total-users-count {
            text-align: center;
            margin-top: 10px;
            font-size: 1em;
            font-weight: 600;
            color: var(--secondary-color);
        }

        /* New Popup for 90 Days Warning */
        #data-warning-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #FFEBEE;
            border: 3px solid #f44336;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(244, 67, 54, 0.5);
            padding: 30px 40px;
            z-index: 2500;
            width: 350px;
            text-align: center;
            color: #C62828;
        }

        #data-warning-popup h4 {
            font-size: 1.3em;
            margin-bottom: 15px;
            font-weight: 900;
        }

        #data-warning-popup p {
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        #data-warning-popup button {
            background: #f44336;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        #data-warning-popup button:hover {
            background: #D32F2F;
            transform: translateY(-2px);
        }

        /* All popups */
        #level-complete-popup,
        #demo-complete-popup,
        #game-over-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            padding: 30px 40px;
            z-index: 2000;
            width: 320px;
            text-align: center;
        }

        #level-complete-popup p,
        #demo-complete-popup p,
        #game-over-popup p {
            font-size: 1.2em;
            margin-bottom: 25px;
            color: var(--secondary-color);
            font-weight: 600;
        }

        #level-complete-popup button,
        #demo-complete-popup button,
        #game-over-popup button {
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1em;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.3s ease;
        }

        #btn-try-next,
        #btn-try-low-level {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 10px rgba(255, 153, 0, 0.4);
        }

        #btn-try-next:hover,
        #btn-try-low-level:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        #btn-exit,
        #btn-exit-demo,
        #btn-go-to-leaderboard {
            background: #6c757d;
            color: white;
            box-shadow: 0 4px 10px rgba(108, 117, 125, 0.4);
        }

        #btn-exit:hover,
        #btn-exit-demo:hover,
        #btn-go-to-leaderboard:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        /* Responsive adjustments */
        @media(max-width: 768px) {
            .stowing-area {
                grid-template-columns: 1fr;
            }

            .pod {
                grid-template-columns: repeat(4, 70px);
                grid-template-rows: repeat(6, 55px);
            }

            .game-controls {
                flex-direction: column;
                align-items: stretch;
            }

            #user-name-input,
            #user-email-input,
            #admin-username-input,
            #admin-password-input {
                width: 90%;
            }

            #leaderboard-table th,
            #leaderboard-table td,
            #admin-leaderboard-table th,
            #admin-leaderboard-table td {
                padding: 8px 5px;
                font-size: 0.7em;
            }
        }

        /* --- END OF ORIGINAL CSS CODE --- */
    </style>
</head>

<body>
    <div id="welcome-screen" role="main" aria-label="Welcome to Fulfillment Center Training Game">
        <div id="welcome-logo" aria-hidden="true">üì¶</div>
        <div id="welcome-title">Stowing Master</div>
        <input id="user-name-input" type="text" placeholder="Enter your Name" aria-label="Enter your name"
            autocomplete="off" />
        <input id="user-email-input" type="email" placeholder="Enter your Email (Primary ID)"
            aria-label="Enter your email" autocomplete="off" />
        <button id="submit-name-btn" aria-label="Submit name and start game">Start Shift</button>
        <button id="show-admin-login-btn" class="admin-action-btn" aria-label="Login as Admin">Admin Login</button>
    </div>
    <div id="admin-login-screen" style="display: none;">
        <div id="welcome-logo" aria-hidden="true">üîí</div>
        <div id="welcome-title">Admin Login</div>
        <input id="admin-username-input" type="text" placeholder="Username" aria-label="Admin username"
            autocomplete="off" />
        <input id="admin-password-input" type="password" placeholder="Password" aria-label="Admin password"
            autocomplete="off" />
        <button id="admin-login-btn" aria-label="Login">Login</button>
        <button id="admin-back-btn" onclick="showWelcomeScreen()">Back to User Start</button>
    </div>
    <div id="game-container" role="main" aria-label="Fulfillment Center Training Game Interface" style="display:none;">
        <div class="header">
            <h1>üì¶ Fulfillment Center Stowing Master</h1>
            <p>Train to become an expert Warehouse Associate</p>
        </div>
        <div class="timer-container">
            <span class="global-timer" id="global-timer">Time Left: 06:00</span>
        </div>
        <div class="game-header">
            <div class="game-title">üéØ Stowing Challenge</div>
            <button id="leaderboard-button" aria-label="View leaderboard">Leaderboard</button>
        </div>
        <div class="stats-dashboard" aria-live="polite" aria-atomic="true">
            <div class="stat-card">
                <div class="stat-number" id="total-score">0</div>
                <div class="stat-label">Total Score</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="accuracy">100%</div>
                <div class="stat-label">Accuracy</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="items-stowed">0</div>
                <div class="stat-label">Items Stowed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="best-combo">0</div>
                <div class="stat-label">Best Combo</div>
            </div>
        </div>
        <div class="game-area">
            <div class="difficulty-selector" role="radiogroup" aria-label="Select difficulty level">
                <button class="difficulty-btn active" aria-pressed="true" role="radio" aria-checked="true"
                    onclick="checkAttemptStatus('easy')" id="easy-btn">Easy</button>
                <button class="difficulty-btn" aria-pressed="false" role="radio" aria-checked="false"
                    onclick="checkAttemptStatus('medium')" id="medium-btn">Medium</button>
                <button class="difficulty-btn" aria-pressed="false" role="radio" aria-checked="false"
                    onclick="checkAttemptStatus('complex')" id="complex-btn">Complex</button>
            </div>
            <div class="instruction-panel">
                <h3 id="current-instruction">üöÄ Click START to begin your shift or TRY DEMO to practice!</h3>
                <div id="game-instructions" style="margin-top: 15px;">
                    <h4 style="color: #E65100; margin-bottom: 10px;">üìã How to Play:</h4>
                    <ul>
                        <li><strong>Watch the Conveyor:</strong> Products will move across the belt showing their name
                            and SKU code</li>
                        <li><strong>Find the Target Bin:</strong> The correct storage bin will be highlighted in orange
                            and pulsing</li>
                        <li><strong>Click to Stow:</strong> Click the highlighted bin to store the product correctly
                        </li>
                        <li><strong>Build Combos:</strong> Consecutive correct stows increase your score multiplier</li>
                        <li><strong>Demo Mode:</strong> Practice without affecting your scores - perfect for learning!
                        </li>
                        <li><strong>Challenge Mode:</strong> Complete 5 challenges per difficulty level to earn points
                        </li>
                    </ul>
                </div>
            </div>
            <div class="stowing-area">
                <div>
                    <div class="conveyor-belt" id="conveyor-belt" aria-live="polite" aria-atomic="true"
                        aria-relevant="additions"></div>
                    <div class="challenge-timer" id="challenge-timer" aria-live="polite" aria-atomic="true">Ready to
                        Start
                    </div>
                </div>
                <div class="pod-container" aria-label="Storage bins">
                    <div class="pod" id="main-pod"></div>
                </div>
            </div>
            <div class="game-controls" role="group" aria-label="Game controls">
                <button class="btn" id="start-btn" onclick="checkAttemptStatus(gameState.difficulty)">üöÄ START
                    SHIFT</button>
                <button class="btn secondary" onclick="pauseGame()" id="pause-btn" disabled>‚è∏Ô∏è PAUSE</button>
                <button class="btn" id="demo-btn" onclick="startDemo()">üéÆ TRY DEMO</button>
            </div>
        </div>
    </div>
    <div id="leaderboard-screen" role="dialog" aria-modal="true" aria-labelledby="leaderboard-title"
        style="display:none;">
        <h2 id="leaderboard-title">Leaderboard</h2>
        <table id="leaderboard-table" aria-describedby="leaderboard-desc" role="table"
            aria-label="Leaderboard showing players scores">
            <thead>
                <tr>
                    <th scope="col">Rank</th>
                    <th scope="col">Name</th>
                    <th scope="col">Email</th>
                    <th scope="col">Level 1</th>
                    <th scope="col">Level 2</th>
                    <th scope="col">Level 3</th>
                    <th scope="col">Accuracy</th>
                    <th scope="col">Total Score</th>
                    <th scope="col">Date</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body"></tbody>
        </table>
        <div class="leaderboard-pagination">
            <button class="pagination-btn" id="prev-page-btn" aria-label="Previous page"> &lt; </button>
            <span id="page-count">Page 1 of 1</span>
            <button class="pagination-btn" id="next-page-btn" aria-label="Next page"> &gt; </button>
        </div>
        <div id="total-users-count">Total Users: 0</div>
        <button id="leaderboard-back-btn" aria-label="Back to game interface">Back</button>
    </div>
    <div id="admin-dashboard" style="display: none;">
        <div class="dashboard-header">
            <h2>üëë Admin Dashboard</h2>
            <p>Full trainee performance report access.</p>
        </div>
        <div id="admin-leaderboard-container">
            <h2 style="text-align: center; color: var(--secondary-color); margin-bottom: 25px;">Full Leaderboard Report
            </h2>
            <table id="admin-leaderboard-table" aria-describedby="admin-leaderboard-desc" role="table"
                aria-label="Admin Leaderboard showing all player scores">
                <thead>
                    <tr>
                        <th scope="col">Rank</th>
                        <th scope="col">Name</th>
                        <th scope="col">Email</th>
                        <th scope="col">Level 1</th>
                        <th scope="col">Level 2</th>
                        <th scope="col">Level 3</th>
                        <th scope="col">Accuracy</th>
                        <th scope="col">Total Score</th>
                        <th scope="col">Date</th>
                    </tr>
                </thead>
                <tbody id="admin-leaderboard-body"></tbody>
            </table>
            <div class="leaderboard-pagination">
                <button class="pagination-btn" id="admin-prev-page-btn" aria-label="Previous page"> &lt; </button>
                <span id="admin-page-count">Page 1 of 1</span>
                <button class="pagination-btn" id="admin-next-page-btn" aria-label="Next page"> &gt; </button>
            </div>
            <div id="admin-total-users-count" style="text-align: center; margin-top: 10px;">Total Users: 0</div>
            <button id="admin-download-report-btn" aria-label="Download report in Excel format">‚¨áÔ∏è DOWNLOAD
                REPORT</button>
            <button id="admin-logout-btn" class="admin-action-btn" aria-label="Logout and return to welcome screen">üîí
                LOGOUT</button>
        </div>
    </div>
    <div class="combo-display" id="combo-display"></div>
    <div id="data-warning-popup" role="alertdialog" aria-modal="true" aria-labelledby="data-warning-title">
        <h4 id="data-warning-title">üö® Data Retention Warning</h4>
        <p>This report data will be **permanently erased** from the server in 90 days. Please download the report now if
            you need to keep a copy!</p>
        <button id="btn-close-warning">Understood</button>
    </div>

    <div id="game-over-popup">
        <p>Time up! Thanks for attending the test.</p>
        <button id="btn-go-to-leaderboard">View Leaderboard</button>
    </div>
    <div id="level-complete-popup">
        <p id="popup-message"></p>
        <button id="btn-try-next">Move to Next Level</button>
        <button id="btn-exit">Exit</button>
    </div>
    <div id="demo-complete-popup">
        <p>Demo completed! Ready for the real challenge?</p>
        <button id="btn-try-low-level">Try Low Level</button>
        <button id="btn-exit-demo">Exit</button>
    </div>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBnQ0s1jFoMH6J7vhKVM7NVC-WNScLdA7E",
            authDomain: "sutherland-6ce2b.firebaseapp.com",
            projectId: "sutherland-6ce2b",
            storageBucket: "sutherland-6ce2b.firebasestorage.app",
            messagingSenderId: "243800407888",
            appId: "1:243800407888:web:2c4dfa1e6a267ba2a17655",
            measurementId: "G-S6GMQ32JJ5"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
    </script>
    <script>
        /* --- Static Admin Credentials --- */
        const ADMIN_USERNAME = 'admin';
        const ADMIN_PASSWORD = 'admin123';
        let isAdminLoggedIn = false;

        /* --- Variables & Data --- */
        let userName = '';
        let userEmail = '';
        let productTimer;
        let animationTimeout;
        let gameClock;
        let gameStartTime;
        const GAME_DURATION_SECONDS = 360; // 6 minutes
        const LEADERBOARD_PAGE_SIZE = 10;
        let currentPage = 1;
        let adminCurrentPage = 1;
        let totalTimeBonus = 0;

        const products = [{
            emoji: 'üì±',
            name: 'iPhone 15 Pro',
            id: 'SKU-EL001'
        }, {
            emoji: 'üíª',
            name: 'MacBook Air M2',
            id: 'SKU-EL002'
        }, {
            emoji: 'üéß',
            name: 'Wireless Earbuds',
            id: 'SKU-EL003'
        }, {
            emoji: 'üìö',
            name: 'Atomic Habits Book',
            id: 'SKU-BK001'
        }, {
            emoji: 'üëï',
            name: 'Athletic T-Shirt',
            id: 'SKU-CL001'
        }, {
            emoji: 'üëü',
            name: 'Running Shoes',
            id: 'SKU-SH001'
        }, {
            emoji: 'üß¥',
            name: 'Face Cleanser',
            id: 'SKU-BT001'
        }, {
            emoji: '‚òï',
            name: 'Coffee Maker',
            id: 'SKU-KT001'
        }, {
            emoji: 'üéÆ',
            name: 'Gaming Controller',
            id: 'SKU-GM001'
        }, {
            emoji: 'üì∫',
            name: 'Streaming Device',
            id: 'SKU-EL004'
        }, {
            emoji: 'üè†',
            name: 'Smart Speaker',
            id: 'SKU-SM001'
        }, {
            emoji: 'üß∏',
            name: 'Teddy Bear Plush',
            id: 'SKU-TY001'
        }, {
            emoji: 'üíä',
            name: 'Vitamin Gummies',
            id: 'SKU-HT001'
        }, {
            emoji: 'üîã',
            name: 'Portable Charger',
            id: 'SKU-EL005'
        }, {
            emoji: 'üéí',
            name: 'Travel Backpack',
            id: 'SKU-BG001'
        }, {
            emoji: 'üç≥',
            name: 'Cast Iron Skillet',
            id: 'SKU-KT002'
        }, {
            emoji: 'üßΩ',
            name: 'Cleaning Sponge',
            id: 'SKU-CL002'
        }, {
            emoji: 'üïØÔ∏è',
            name: 'Scented Candle',
            id: 'SKU-HM001'
        }, {
            emoji: 'üèãÔ∏è',
            name: 'Resistance Bands',
            id: 'SKU-FT001'
        }, {
            emoji: 'üßä',
            name: 'Insulated Tumbler',
            id: 'SKU-DR001'
        }];

        const rows = ['F', 'E', 'D', 'C', 'B', 'A'];
        const cols = [1, 2, 3, 4];

        let gameState = {
            isActive: false,
            isPaused: false,
            score: 0,
            accuracy: 100,
            itemsStowed: 0,
            correctStows: 0,
            totalAttempts: 0,
            combo: 0,
            bestCombo: 0,
            difficulty: 'easy',
            currentProduct: null,
            targetBin: null,
            challengesCompleted: 0,
            totalChallenges: 5,
            isDemo: false,
            levelScores: {
                easy: 0,
                medium: 0,
                complex: 0
            },
            levelAttempts: {
                easy: { correct: 0, total: 0 },
                medium: { correct: 0, total: 0 },
                complex: { correct: 0, total: 0 }
            }
        };
        // Leaderboard data from Firebase
        let leaderboard = [];

        /* --- DOM Elements --- */
        const globalTimerDisplay = document.getElementById('global-timer');
        const challengeTimerDisplay = document.getElementById('challenge-timer');
        let timeRemaining = GAME_DURATION_SECONDS;
        let pageCountSpan;
        let prevPageBtn;
        let nextPageBtn;
        let totalUsersCountSpan;
        let adminPageCountSpan;
        let adminPrevPageBtn;
        let adminNextPageBtn;
        let adminTotalUsersCountSpan;

        /* --- Firebase Leaderboard Setup --- */
        function setupLeaderboardListener() {
            const leaderboardRef = firebase.database().ref('leaderboard');
            leaderboardRef.on('value', (snapshot) => {
                const data = snapshot.val() || {};
                leaderboard = Object.values(data);
                updateLeaderboardTable('leaderboard-body', 'page-count', 'prev-page-btn', 'next-page-btn', 'total-users-count');
                if (isAdminLoggedIn) {
                    updateAdminLeaderboardTable();
                }
            });
        }
        /* --- View Management Functions --- */
        function hideAllScreens() {
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('admin-login-screen').style.display = 'none';
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('leaderboard-screen').style.display = 'none';
            document.getElementById('admin-dashboard').style.display = 'none';
        }

        function showWelcomeScreen() {
            hideAllScreens();
            document.getElementById('welcome-screen').style.display = 'flex';
            // Clear inputs on logout/return
            document.getElementById('admin-username-input').value = '';
            document.getElementById('admin-password-input').value = '';
        }

        function showAdminLoginScreen() {
            hideAllScreens();
            document.getElementById('admin-login-screen').style.display = 'flex';
        }

        function showAdminDashboard() {
            hideAllScreens();
            isAdminLoggedIn = true;
            adminCurrentPage = 1; // Reset admin page to 1
            document.getElementById('admin-dashboard').style.display = 'block';
            updateAdminLeaderboardTable();
        }

        function handleAdminLogout() {
            isAdminLoggedIn = false;
            showWelcomeScreen();
        }
        /* --- Admin Login Logic --- */
        function adminLogin() {
            const username = document.getElementById('admin-username-input').value.trim();
            const password = document.getElementById('admin-password-input').value.trim();

            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                showAdminDashboard();
            } else {
                alert('Invalid Admin Credentials.');
            }
        }

        document.getElementById('admin-login-btn').onclick = adminLogin;
        document.getElementById('show-admin-login-btn').onclick = showAdminLoginScreen;
        document.getElementById('admin-logout-btn').onclick = handleAdminLogout;
        document.getElementById('admin-download-report-btn').onclick = downloadReport;

        /* --- Validate User Input --- */
        function validateUserInfo() {
            const nameInput = document.getElementById('user-name-input').value.trim();
            const emailInput = document.getElementById('user-email-input').value.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (!nameInput) {
                alert("Please enter your Name.");
                document.getElementById('user-name-input').focus();
                return false;
            }
            if (!emailInput || !emailRegex.test(emailInput)) {
                alert("Please enter a valid Email (used as your unique ID).");
                document.getElementById('user-email-input').focus();
                return false;
            }

            userName = nameInput;
            userEmail = emailInput;
            return true;
        }
        /* --- Enforce Single Attempt Per Level --- */
        function checkAttemptStatus(level) {
            if (!userEmail) {
                alert('Please enter your name and email on the welcome screen first.');
                document.getElementById('welcome-screen').style.display = 'flex';
                document.getElementById('game-container').style.display = 'none';
                return;
            }

            if (level === 'easy' || level === 'medium' || level === 'complex') {
                gameState.difficulty = level;
                // Visually update the active button
                document.querySelectorAll('.difficulty-btn').forEach(btn => {
                    btn.classList.remove('active');
                    btn.setAttribute('aria-pressed', 'false');
                    btn.setAttribute('aria-checked', 'false');
                });
                const btn = document.getElementById(level + '-btn');
                if (btn) {
                    btn.classList.add('active');
                    btn.setAttribute('aria-pressed', 'true');
                    btn.setAttribute('aria-checked', 'true');
                }
            }

            const userRef = firebase.database().ref('leaderboard/' + userEmail.replace(/[.$#[\]/]/g, '_'));
            userRef.once('value', (snapshot) => {
                const userData = snapshot.val();
                const currentLevelScore = userData && userData.scores ? userData.scores[level] : 0;

                if (currentLevelScore > 0) {
                    // Level has been completed before (score > 0)
                    alert(`üö´ Level Already Completed: You have already completed the ${level} level. You cannot re-attempt it.`);
                    // Disable the Start/Pause button until a valid, incomplete level is selected
                    document.getElementById('start-btn').disabled = true;
                    return;
                } else {
                    // Level has not been completed or is a fresh start
                    document.getElementById('start-btn').disabled = false;
                    startGame();
                }
            });
        }
        /* --- Initialize game --- */
        function initializeGame() {
            // Initialize DOM references for pagination here to prevent ReferenceError
            pageCountSpan = document.getElementById('page-count');
            prevPageBtn = document.getElementById('prev-page-btn');
            nextPageBtn = document.getElementById('next-page-btn');
            totalUsersCountSpan = document.getElementById('total-users-count');
            adminPageCountSpan = document.getElementById('admin-page-count');
            adminPrevPageBtn = document.getElementById('admin-prev-page-btn');
            adminNextPageBtn = document.getElementById('admin-next-page-btn');
            adminTotalUsersCountSpan = document.getElementById('admin-total-users-count');

            createPod();
            populateRandomBins();
            resetGame();
            updateStats();
            updateGlobalTimerDisplay(GAME_DURATION_SECONDS); // Display initial time
            challengeTimerDisplay.textContent = 'Ready to Start';
            document.getElementById('current-instruction').textContent = 'üöÄ Click START to begin your shift or TRY DEMO to practice! (Select a difficulty level first)';
            document.getElementById('game-instructions').style.display = 'block';
            document.getElementById('start-btn').disabled = true; // Disabled until checkAttemptStatus enables it
            document.getElementById('pause-btn').disabled = true;
            document.getElementById('demo-btn').disabled = false;
            document.getElementById('pause-btn').textContent = '‚è∏Ô∏è PAUSE';
            // Set initial difficulty, but don't start the game
            setDifficulty('easy');
        }
        /* --- Create storage bins --- */
        function createPod() {
            const pod = document.getElementById('main-pod');
            pod.innerHTML = '';
            rows.forEach(r => {
                cols.forEach(c => {
                    const bin = document.createElement('div');
                    bin.className = 'bin';
                    bin.id = `bin-${r}${c}`;
                    bin.tabIndex = 0;
                    bin.setAttribute('role', 'button');
                    bin.setAttribute('aria-label', `Storage bin ${r}${c}`);
                    bin.onclick = () => handleBinClick(r + c);
                    bin.onkeydown = e => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            handleBinClick(r + c);
                        }
                    };
                    const label = document.createElement('div');
                    label.className = 'bin-label';
                    label.textContent = r + c;
                    const content = document.createElement('div');
                    content.className = 'bin-content';
                    bin.appendChild(label);
                    bin.appendChild(content);
                    pod.appendChild(bin);
                });
            });
        }
        /* --- Populate random bins --- */
        function populateRandomBins() {
            const bins = document.querySelectorAll('.bin');
            bins.forEach(b => {
                b.classList.remove('occupied', 'correct', 'incorrect', 'target');
                b.querySelector('.bin-content').textContent = '';
            });
            const count = Math.floor(Math.random() * 8) + 4;
            const selected = Array.from(bins).sort(() => 0.5 - Math.random()).slice(0, count);
            selected.forEach(bin => {
                bin.classList.add('occupied');
                const product = products[Math.floor(Math.random() * products.length)];
                bin.querySelector('.bin-content').textContent = product.emoji;
            });
        }
        /* --- Set difficulty (internal update only, does not start game) --- */
        function setDifficulty(level) {
            gameState.difficulty = level;
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-pressed', 'false');
                btn.setAttribute('aria-checked', 'false');
            });
            const btn = document.getElementById(level + '-btn');
            if (btn) {
                btn.classList.add('active');
                btn.setAttribute('aria-pressed', 'true');
                btn.setAttribute('aria-checked', 'true');
            }
            if (!gameState.isActive) {
                challengeTimerDisplay.textContent = `Challenge 1 of 5`;
            }
        }

        function updateGlobalTimerDisplay(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            const formattedTime = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            globalTimerDisplay.textContent = `Time Left: ${formattedTime}`;
        }
        /* --- Start game (called after checkAttemptStatus passes) --- */
        function startGame() {
            if (!userEmail) return;

            if (!(gameState.isActive && !gameState.isDemo)) {
                resetGame();
                gameStartTime = Date.now();
                timeRemaining = GAME_DURATION_SECONDS;
            }

            gameState.isActive = true;
            gameState.isPaused = false;
            gameState.isDemo = false;
            gameState.challengesCompleted = 0;

            document.getElementById('start-btn').disabled = true;
            document.getElementById('pause-btn').disabled = false;
            document.getElementById('demo-btn').disabled = true;
            document.getElementById('current-instruction').textContent = `üëÄ Starting ${gameState.difficulty.toUpperCase()} level! Stow the product in the highlighted bin.`;
            document.getElementById('game-instructions').style.display = 'none';

            updateGlobalTimerDisplay(timeRemaining);
            if (!gameClock) {
                gameClock = setInterval(() => {
                    timeRemaining--;
                    updateGlobalTimerDisplay(timeRemaining);
                    if (timeRemaining <= 0) {
                        clearInterval(gameClock);
                        gameClock = null;
                        showGameOverPopup();
                    }
                }, 1000);
            }

            updateStats();
            updateChallengeDisplay();
            scheduleNextProduct();
        }
        /* --- Start demo mode (always allowed) --- */
        function startDemo() {
            if (!userEmail) {
                alert('Please enter your name and email before starting the demo.');
                return;
            }
            resetGame(true);
            gameState.isActive = true;
            gameState.isPaused = false;
            gameState.isDemo = true;
            document.getElementById('start-btn').disabled = true;
            document.getElementById('pause-btn').disabled = false;
            document.getElementById('demo-btn').disabled = true;
            document.getElementById('current-instruction').textContent = 'üéÆ DEMO MODE - Practice stowing without affecting your scores!';
            document.getElementById('game-instructions').style.display = 'none';
            challengeTimerDisplay.textContent = 'DEMO MODE';
            scheduleNextProduct();
        }
        /* --- Reset game stats --- */
        function resetGame(isDemoReset = false) {
            // General reset
            gameState.isActive = false;
            gameState.isPaused = false;
            gameState.combo = 0;
            gameState.currentProduct = null;
            gameState.targetBin = null;

            const belt = document.getElementById('conveyor-belt');
            belt.innerHTML = '';
            document.querySelectorAll('.bin').forEach(b => b.classList.remove('target', 'correct', 'incorrect'));
            if (productTimer) clearTimeout(productTimer);
            if (animationTimeout) clearTimeout(animationTimeout);
            if (!isDemoReset && gameClock) {
                clearInterval(gameClock);
                gameClock = null;
            }

            if (!isDemoReset) {
                // Full shift reset (for START SHIFT or END GAME)
                gameState.score = 0;
                gameState.accuracy = 100;
                gameState.itemsStowed = 0;
                gameState.correctStows = 0;
                gameState.totalAttempts = 0;
                gameState.bestCombo = 0;
                gameState.levelScores = {
                    easy: 0,
                    medium: 0,
                    complex: 0
                };
                gameState.levelAttempts = {
                    easy: { correct: 0, total: 0 },
                    medium: { correct: 0, total: 0 },
                    complex: { correct: 0, total: 0 }
                };
                totalTimeBonus = 0;
                timeRemaining = GAME_DURATION_SECONDS;
            }

            gameState.challengesCompleted = 0;
        }
        /* --- Pause/Resume --- */
        function pauseGame() {
            if (!gameState.isActive) return;
            gameState.isPaused = !gameState.isPaused;
            const btn = document.getElementById('pause-btn');
            if (gameState.isPaused) {
                btn.textContent = '‚ñ∂Ô∏è RESUME';
                clearTimeout(productTimer);
                if (gameClock) clearInterval(gameClock);
                document.getElementById('current-instruction').textContent = '‚è∏Ô∏è Game Paused - Click RESUME to continue';
                const prod = document.querySelector('.product-item');
                if (prod) prod.style.animationPlayState = 'paused';
            } else {
                btn.textContent = '‚è∏Ô∏è PAUSE';

                let timeText = globalTimerDisplay.textContent.split(':');
                if (timeText.length === 2) {
                    let minutes = parseInt(timeText[0].split(' ')[2]);
                    let seconds = parseInt(timeText[1]);
                    timeRemaining = (minutes * 60) + seconds;
                } else {
                    timeRemaining = GAME_DURATION_SECONDS;
                }

                if (!gameState.isDemo) {
                    gameClock = setInterval(() => {
                        timeRemaining--;
                        updateGlobalTimerDisplay(timeRemaining);
                        if (timeRemaining <= 0) {
                            clearInterval(gameClock);
                            gameClock = null;
                            showGameOverPopup();
                        }
                    }, 1000);
                }

                scheduleNextProduct();
                const txt = gameState.isDemo ? 'üéÆ DEMO MODE - Practice stowing without affecting your scores!' : 'üëÄ Watch for products and stow!';
                document.getElementById('current-instruction').textContent = txt;
                const prod = document.querySelector('.product-item');
                if (prod) prod.style.animationPlayState = 'running';
            }
        }
        /* --- Schedule next product --- */
        function scheduleNextProduct() {
            if (!gameState.isActive || gameState.isPaused) return;

            if (gameState.isDemo && gameState.challengesCompleted >= gameState.totalChallenges) {
                showDemoCompletePopup();
                return;
            }

            if (!gameState.isDemo && gameState.challengesCompleted >= gameState.totalChallenges) {
                showLevelCompletePopup();
                return;
            }

            const delay = gameState.difficulty === 'easy' ? 4000 : (gameState.difficulty === 'medium') ? 3000 : 2000;

            const belt = document.getElementById('conveyor-belt');
            belt.innerHTML = '';
            document.querySelectorAll('.bin').forEach(b => b.classList.remove('target'));

            productTimer = setTimeout(showProduct, delay);
        }
        /* --- Show product --- */
        function showProduct() {
            if (!gameState.isActive || gameState.isPaused) return;

            const belt = document.getElementById('conveyor-belt');
            const bins = document.querySelectorAll('.bin');

            belt.innerHTML = '';
            bins.forEach(b => b.classList.remove('target', 'incorrect', 'correct'));

            gameState.currentProduct = products[Math.floor(Math.random() * products.length)];

            const emptyBins = Array.from(bins).filter(b => !b.classList.contains('occupied'));
            if (emptyBins.length === 0) {
                populateRandomBins();
                const newEmptyBins = Array.from(document.querySelectorAll('.bin')).filter(b => !b.classList.contains('occupied'));
                gameState.targetBin = newEmptyBins[Math.floor(Math.random() * newEmptyBins.length)].id.replace('bin-', '');
            } else {
                gameState.targetBin = emptyBins[Math.floor(Math.random() * emptyBins.length)].id.replace('bin-', '');
            }

            const prodDiv = document.createElement('div');
            prodDiv.className = 'product-item';
            let duration = '8s';
            if (gameState.difficulty === 'medium') duration = '5.5s';
            else if (gameState.difficulty === 'complex') duration = '4s';
            prodDiv.style.animationDuration = duration;
            prodDiv.innerHTML = `<div class="product-emoji">${gameState.currentProduct.emoji}</div><div class="product-info"><div class="product-name">${gameState.currentProduct.name}</div><div class="product-id">${gameState.currentProduct.id}</div></div>`;
            belt.appendChild(prodDiv);

            document.getElementById(`bin-${gameState.targetBin}`).classList.add('target');
            document.getElementById('current-instruction').textContent = `üì¶ Stow ${gameState.currentProduct.name} in bin ${gameState.targetBin}`;

            animationTimeout = setTimeout(() => {
                if (gameState.currentProduct) {
                    handleMissedStow();
                }
            }, (parseFloat(duration) * 1000) - 100);
        }
        /* --- Handle missed stow --- */
        function handleMissedStow() {
            if (!gameState.isActive || gameState.isPaused) return;
            if (!gameState.isDemo) {
                gameState.totalAttempts++;
                gameState.levelAttempts[gameState.difficulty].total++;
                gameState.combo = 0;
                gameState.accuracy = Math.round(gameState.correctStows / gameState.totalAttempts * 100);
                updateStats();
            }
            const belt = document.getElementById('conveyor-belt');
            belt.innerHTML = '';
            const targetBin = document.getElementById(`bin-${gameState.targetBin}`);
            if (targetBin) {
                targetBin.classList.remove('target');
            }
            gameState.currentProduct = null;
            gameState.targetBin = null;
            scheduleNextProduct();
        }
        /* --- Handle bin click --- */
        function handleBinClick(binId) {
            if (!gameState.isActive || gameState.isPaused || !gameState.currentProduct) return;

            clearTimeout(animationTimeout);

            const bin = document.getElementById(`bin-${binId}`);
            const belt = document.getElementById('conveyor-belt');
            const productElement = belt.querySelector('.product-item');

            if (productElement) {
                productElement.remove();
            }

            if (binId === gameState.targetBin) {
                bin.classList.add('correct');
                if (!gameState.isDemo) {
                    gameState.totalAttempts++;
                    gameState.correctStows++;
                    gameState.itemsStowed++;
                    gameState.combo++;
                    gameState.challengesCompleted++;
                    gameState.levelAttempts[gameState.difficulty].total++;
                    gameState.levelAttempts[gameState.difficulty].correct++;

                    gameState.score += 5;
                    gameState.levelScores[gameState.difficulty] += 5;

                    if (gameState.combo > gameState.bestCombo) gameState.bestCombo = gameState.combo;

                    if (gameState.combo === 3) {
                        showCombo('3x COMBO!');
                    }
                    if (gameState.combo === 5) {
                        showCombo('PERFECT!');
                    }

                    gameState.accuracy = Math.round((gameState.correctStows / gameState.totalAttempts) * 100);
                    updateStats();
                } else {
                    gameState.challengesCompleted++;
                }

                bin.querySelector('.bin-content').textContent = gameState.currentProduct.emoji;
                bin.classList.add('occupied');

                gameState.currentProduct = null;
                gameState.targetBin = null;

                setTimeout(() => {
                    bin.classList.remove('correct', 'target');
                    if (gameState.isDemo || gameState.challengesCompleted < gameState.totalChallenges) {
                        updateChallengeDisplay();
                        scheduleNextProduct();
                    } else if (!gameState.isDemo && gameState.challengesCompleted >= gameState.totalChallenges) {
                        showLevelCompletePopup();
                    }
                }, 1000);

            } else {
                bin.classList.add('incorrect');
                if (!gameState.isDemo) {
                    gameState.totalAttempts++;
                    gameState.levelAttempts[gameState.difficulty].total++;
                    gameState.combo = 0;
                    gameState.accuracy = Math.round((gameState.correctStows / gameState.totalAttempts) * 100);
                    updateStats();
                }

                const targetBin = document.getElementById(`bin-${gameState.targetBin}`);
                if (targetBin) {
                    targetBin.classList.add('target-error');
                    setTimeout(() => targetBin.classList.remove('target-error'), 1000);
                }

                gameState.currentProduct = null;
                gameState.targetBin = null;

                setTimeout(() => {
                    bin.classList.remove('incorrect');
                    scheduleNextProduct();
                }, 1000);
            }
        }
        /* --- Show combo --- */
        function showCombo(text) {
            const comboDiv = document.getElementById('combo-display');
            comboDiv.textContent = text;
            comboDiv.style.display = 'block';
            setTimeout(() => {
                comboDiv.style.display = 'none';
            }, 1500);
        }
        /* --- Update stats --- */
        function updateStats() {
            document.getElementById('total-score').textContent = gameState.score.toLocaleString();
            document.getElementById('accuracy').textContent = gameState.totalAttempts === 0 ? '100%' : Math.round((gameState.correctStows / gameState.totalAttempts) * 100) + '%';
            document.getElementById('items-stowed').textContent = gameState.itemsStowed;
            document.getElementById('best-combo').textContent = gameState.bestCombo;
        }

        function updateChallengeDisplay() {
            if (gameState.isDemo) {
                challengeTimerDisplay.textContent = 'DEMO MODE';
            } else {
                challengeTimerDisplay.textContent = `Challenge ${gameState.challengesCompleted + 1} of ${gameState.totalChallenges}`;
            }
        }
        /* --- Calculate Time Bonus --- */
        function calculateTimeBonus() {
            const timeElapsed = (Date.now() - gameStartTime) / 1000;
            if (timeElapsed <= 120) { // 2 minutes
                return 25;
            } else if (timeElapsed <= 180) { // 3 minutes
                return 15;
            } else if (timeElapsed <= 240) { // 4 minutes
                return 10;
            } else if (timeElapsed <= 300) { // 5 minutes
                return 5;
            } else {
                return 0;
            }
        }
        /* --- Firebase Leaderboard update --- */
        function addOrUpdateLeaderboardEntry(isFinalUpdate = false) {
            if (!userEmail || gameState.isDemo || gameState.totalAttempts === 0) {
                return;
            }

            const userRef = firebase.database().ref('leaderboard/' + userEmail.replace(/[.$#[\]/]/g, '_'));
            userRef.once('value', (snapshot) => {
                let data = snapshot.val() || {
                    name: userName,
                    email: userEmail,
                    scores: {
                        easy: 0,
                        medium: 0,
                        complex: 0
                    },
                    accuracy: { easy: { correct: 0, total: 0 }, medium: { correct: 0, total: 0 }, complex: { correct: 0, total: 0 } },
                    totalScore: 0,
                    totalAccuracy: 0,
                    // NEW FIELD: Stores dates for each level completion
                    dates: {
                        easy: null,
                        medium: null,
                        complex: null
                    }
                };

                data.name = userName;
                data.email = userEmail;

                let hasNewLevelCompleted = false;

                for (const level of ['easy', 'medium', 'complex']) {
                    if (gameState.levelScores[level] > 0) {
                        if (gameState.levelScores[level] > data.scores[level]) {
                            data.scores[level] = gameState.levelScores[level];
                            data.accuracy[level].correct = gameState.levelAttempts[level].correct;
                            data.accuracy[level].total = gameState.levelAttempts[level].total;

                            // CRITICAL DATE SAVE: Save the timestamp when a level is completed (score is updated)
                            if (!data.dates[level] || data.scores[level] > 0) {
                                data.dates[level] = firebase.database.ServerValue.TIMESTAMP;
                                hasNewLevelCompleted = true;
                            }
                        }
                    }
                }

                let totalScoreSum = 0;
                let totalCorrectSum = 0;
                let totalAttemptsSum = 0;

                for (const level in data.scores) {
                    totalScoreSum += data.scores[level];
                    totalCorrectSum += data.accuracy[level].correct;
                    totalAttemptsSum += data.accuracy[level].total;
                }

                // Apply time bonus and update total score only on FINAL save (End Game)
                if (isFinalUpdate) {
                    const allLevelsCompleted = data.scores.easy > 0 && data.scores.medium > 0 && data.scores.complex > 0;

                    if (allLevelsCompleted || timeRemaining <= 0) {
                        totalTimeBonus = calculateTimeBonus();
                        data.totalScore = totalScoreSum + totalTimeBonus;
                    } else {
                        data.totalScore = totalScoreSum;
                    }
                } else {
                    data.totalScore = totalScoreSum;
                }

                data.totalAccuracy = (totalAttemptsSum > 0) ? Math.round((totalCorrectSum / totalAttemptsSum) * 100) : 0;

                userRef.set(data);
            });
        }

        /* --- Utility to format date (REFINED FOR LEVEL DATES) --- */
        function formatDate(timestamp, levelDates = null) {
            let finalTimestamp = timestamp;

            // If a levelDates object is passed, find the latest completed date for display
            if (levelDates) {
                const dates = Object.values(levelDates);
                // Filter out non-numbers (null, placeholder object, N/A) and find the maximum (latest) resolved date
                const resolvedDates = dates.filter(t => typeof t === 'number');
                if (resolvedDates.length > 0) {
                    finalTimestamp = Math.max(...resolvedDates);
                } else {
                    // If no resolved dates, but some placeholders exist, show loading
                    if (dates.some(t => typeof t === 'object' && t !== null && t['.sv'] === 'timestamp')) {
                        finalTimestamp = { '.sv': 'timestamp' }; // Pass the placeholder object
                    } else {
                        finalTimestamp = null; // No resolved dates and no pending dates
                    }
                }
            }


            // State 1: Missing data (null or undefined)
            if (!finalTimestamp) {
                return 'N/A';
            }

            // State 2: Unresolved Firebase placeholder object (e.g., {".sv":"timestamp"})
            if (typeof finalTimestamp === 'object' && finalTimestamp !== null && finalTimestamp['.sv'] === 'timestamp') {
                return '...'; // Data is pending from the server
            }

            // State 3: Resolved data (Actual numerical timestamp)
            if (typeof finalTimestamp === 'number') {
                const date = new Date(finalTimestamp);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'numeric',
                    day: 'numeric'
                });
            }

            return 'N/A';
        }

        /* --- Download Report Function --- */
        function downloadReport() {
            if (leaderboard.length === 0) {
                alert('No data to download.');
                return;
            }

            const headers = [
                'Rank', 'Name', 'Email', 'Level 1 Score', 'Level 2 Score', 'Level 3 Score',
                'Total Correct Attempts', 'Total Attempts', 'Overall Accuracy (%)', 'Total Score',
                'Easy Completion Date', 'Medium Completion Date', 'Complex Completion Date', 'Latest Completion Date'
            ];

            const sorted = [...leaderboard].sort((a, b) => (b.totalScore || 0) - (a.totalScore || 0));

            let csvContent = headers.join(',') + '\n';

            sorted.forEach((entry, index) => {
                const rank = index + 1;
                const scores = entry.scores || {};
                const accuracy = entry.accuracy || { easy: { correct: 0, total: 0 }, medium: { correct: 0, total: 0 }, complex: { correct: 0, total: 0 } };
                const dates = entry.dates || {};

                const totalCorrect = (accuracy.easy.correct || 0) + (accuracy.medium.correct || 0) + (accuracy.complex.correct || 0);
                const totalAttempts = (accuracy.easy.total || 0) + (accuracy.medium.total || 0) + (accuracy.complex.total || 0);

                // Get individual level dates for CSV
                const easyDate = formatDate(dates.easy);
                const mediumDate = formatDate(dates.medium);
                const complexDate = formatDate(dates.complex);

                // Get the overall latest date for the CSV column (using the refined logic in formatDate)
                const latestCompletionDate = formatDate(null, dates);


                const row = [
                    rank,
                    `"${entry.name || 'N/A'}"`,
                    `"${entry.email || 'N/A'}"`,
                    scores.easy || 0,
                    scores.medium || 0,
                    scores.complex || 0,
                    totalCorrect,
                    totalAttempts,
                    entry.totalAccuracy || 0,
                    entry.totalScore || 0,
                    (easyDate === '...') ? 'N/A (Pending)' : easyDate,
                    (mediumDate === '...') ? 'N/A (Pending)' : mediumDate,
                    (complexDate === '...') ? 'N/A (Pending)' : complexDate,
                    (latestCompletionDate === '...') ? 'N/A (Pending)' : latestCompletionDate
                ].join(',');
                csvContent += row + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');

            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'StowingMaster_Report_' + new Date().toISOString().slice(0, 10) + '.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert('Your browser does not support downloading files directly. Please copy the data from the table.');
            }
        }
        /* --- Leaderboard Functions (User Modal) --- */
        function showLeaderboardScreen() {
            currentPage = 1;
            updateLeaderboardTable('leaderboard-body', 'page-count', 'prev-page-btn', 'next-page-btn', 'total-users-count');
            document.getElementById('leaderboard-screen').style.display = 'block';
            document.getElementById('game-container').style.display = 'none';
        }

        function closeLeaderboardScreen() {
            document.getElementById('leaderboard-screen').style.display = 'none';
            document.getElementById('game-container').style.display = 'block';
        }
        /* --- Leaderboard Functions (Admin Dashboard) --- */
        function updateAdminLeaderboardTable() {
            updateLeaderboardTable('admin-leaderboard-body', 'admin-page-count', 'admin-prev-page-btn', 'admin-next-page-btn', 'admin-total-users-count', true);
        }

        // Universal Leaderboard Renderer
        function updateLeaderboardTable(bodyId, pageCountId, prevBtnId, nextBtnId, totalUsersId, isAdmin = false) {
            const tableBody = document.getElementById(bodyId);
            const pageCountEl = document.getElementById(pageCountId);
            const prevBtn = document.getElementById(prevBtnId);
            const nextBtn = document.getElementById(nextBtnId);
            const totalUsersEl = document.getElementById(totalUsersId);
            let page = isAdmin ? adminCurrentPage : currentPage;
            tableBody.innerHTML = '';
            const sorted = [...leaderboard].sort((a, b) => (b.totalScore || 0) - (a.totalScore || 0));
            const totalUsers = sorted.length;
            const totalPages = Math.ceil(totalUsers / LEADERBOARD_PAGE_SIZE);

            const startIndex = (page - 1) * LEADERBOARD_PAGE_SIZE;
            const endIndex = startIndex + LEADERBOARD_PAGE_SIZE;
            const displayedEntries = sorted.slice(startIndex, endIndex);

            displayedEntries.forEach((entry, index) => {
                const tr = document.createElement('tr');
                const rank = startIndex + index + 1;

                const scores = entry.scores || {};
                const totalAccuracy = entry.totalAccuracy || 0;
                const totalScore = entry.totalScore || 0;
                const dates = entry.dates || {};

                // Use the refined formatDate function to get the latest completed date from any level
                const date = formatDate(null, dates);


                if (rank === 1) {
                    tr.classList.add('rank-1st');
                } else if (rank === 2) {
                    tr.classList.add('rank-2nd');
                } else if (rank === 3) {
                    tr.classList.add('rank-3rd');
                }

                tr.innerHTML = `
                    <td>${rank}</td>
                    <td>${entry.name || 'N/A'}</td>
                    <td>${entry.email || 'N/A'}</td>
                    <td>${scores.easy || 0}</td>
                    <td>${scores.medium || 0}</td>
                    <td>${scores.complex || 0}</td>
                    <td>${totalAccuracy}%</td>
                    <td>${totalScore}</td>
                    <td>${date}</td>
                `;
                tableBody.appendChild(tr);
            });

            // Update pagination controls and user count
            if (pageCountEl) pageCountEl.textContent = `Page ${page} of ${totalPages || 1}`;
            if (prevBtn) prevBtn.disabled = page === 1;
            if (nextBtn) nextBtn.disabled = page >= totalPages;
            if (totalUsersEl) totalUsersEl.textContent = `Total Users: ${totalUsers}`;
        }

        /* --- 90-Day Warning Popup Logic (Client-side notification) --- */
        function showDataWarningPopupIfNecessary() {
            if (leaderboard.length > 0) {
                const lastDismissal = localStorage.getItem('dataWarningDismissal');
                const today = new Date().toDateString();

                if (lastDismissal === today) {
                    return;
                }

                document.getElementById('data-warning-popup').style.display = 'block';
            }
        }

        function closeDataWarningPopup() {
            localStorage.setItem('dataWarningDismissal', new Date().toDateString());
            document.getElementById('data-warning-popup').style.display = 'none';
        }
        document.getElementById('btn-close-warning').onclick = closeDataWarningPopup;

        /* --- Level complete popup --- */
        function showLevelCompletePopup() {
            if (gameState.isDemo) {
                showDemoCompletePopup();
                return;
            }

            pauseGame();
            // Intermediate save (isFinalUpdate = false) which now saves the level date
            addOrUpdateLeaderboardEntry(false);

            document.getElementById('popup-message').textContent = `Successfully completed the ${gameState.difficulty} level!`;
            document.getElementById('level-complete-popup').style.display = 'block';

            const nextLevelBtn = document.getElementById('btn-try-next');
            const exitBtn = document.getElementById('btn-exit');
            const difficulties = ['easy', 'medium', 'complex'];
            const currentLevelIndex = difficulties.indexOf(gameState.difficulty);
            const currentUserEntry = leaderboard.find(entry => entry.email === userEmail) || { scores: {} };

            if (currentLevelIndex >= difficulties.length - 1) {
                nextLevelBtn.style.display = 'none';
                exitBtn.textContent = 'View Leaderboard';
            } else {
                const nextLevel = difficulties[currentLevelIndex + 1];
                const isNextLevelCompleted = currentUserEntry.scores[nextLevel] > 0;

                if (isNextLevelCompleted) {
                    nextLevelBtn.style.display = 'none';
                    exitBtn.textContent = 'Exit';
                    alert(`The next level (${nextLevel}) has already been completed. You must exit or choose an unattempted level.`);
                } else {
                    nextLevelBtn.style.display = 'inline-block';
                    exitBtn.textContent = 'Exit';
                }
            }
        }

        function closeLevelCompletePopup() {
            document.getElementById('level-complete-popup').style.display = 'none';
        }

        function showDemoCompletePopup() {
            document.getElementById('demo-complete-popup').style.display = 'block';
            pauseGame();
        }

        function closeDemoCompletePopup() {
            document.getElementById('demo-complete-popup').style.display = 'none';
        }

        function showGameOverPopup() {
            // Final save (isFinalUpdate = true)
            endGame(true);
            document.getElementById('game-over-popup').style.display = 'block';
        }

        function goToLeaderboardFromPopup() {
            closeGameOverPopup();
            showLeaderboardScreen();
        }

        function closeGameOverPopup() {
            document.getElementById('game-over-popup').style.display = 'none';
        }
        /* --- End Game --- */
        function endGame(timeExpired = false) {
            clearTimeout(productTimer);
            clearTimeout(animationTimeout);

            if (gameClock && timeExpired) {
                clearInterval(gameClock);
                gameClock = null;
            }

            gameState.isActive = false;
            document.getElementById('start-btn').disabled = false;
            document.getElementById('pause-btn').disabled = true;
            document.getElementById('demo-btn').disabled = false;

            if (!gameState.isDemo && gameState.totalAttempts > 0) {
                // Final save on exit or time out
                addOrUpdateLeaderboardEntry(true);
            }
        }
        /* --- Event Listeners --- */
        document.getElementById('submit-name-btn').onclick = () => {
            if (!validateUserInfo()) {
                return;
            }
            hideAllScreens();
            document.getElementById('game-container').style.display = 'block';
            initializeGame();
        };

        document.getElementById('leaderboard-button').onclick = () => {
            if (userEmail) {
                if (gameState.isActive && !gameState.isDemo) {
                    // Intermediate save to ensure latest scores/dates are reflected
                    addOrUpdateLeaderboardEntry(false);
                }

                if (gameState.isActive) {
                    pauseGame();
                }
            }

            showDataWarningPopupIfNecessary();
            showLeaderboardScreen();
        };

        document.getElementById('leaderboard-back-btn').onclick = () => {
            closeLeaderboardScreen();
            if (gameState.isActive && gameState.isPaused) {
                pauseGame();
            }
        };

        document.getElementById('admin-prev-page-btn').onclick = () => {
            if (adminCurrentPage > 1) {
                adminCurrentPage--;
                updateAdminLeaderboardTable();
            }
        };

        document.getElementById('admin-next-page-btn').onclick = () => {
            const totalPages = Math.ceil(leaderboard.length / LEADERBOARD_PAGE_SIZE);
            if (adminCurrentPage < totalPages) {
                adminCurrentPage++;
                updateAdminLeaderboardTable();
            }
        };

        document.getElementById('prev-page-btn').onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                updateLeaderboardTable('leaderboard-body', 'page-count', 'prev-page-btn', 'next-page-btn', 'total-users-count');
            }
        };

        document.getElementById('next-page-btn').onclick = () => {
            const totalPages = Math.ceil(leaderboard.length / LEADERBOARD_PAGE_SIZE);
            if (currentPage < totalPages) {
                currentPage++;
                updateLeaderboardTable('leaderboard-body', 'page-count', 'prev-page-btn', 'next-page-btn', 'total-users-count');
            }
        };

        document.getElementById('btn-try-next').onclick = () => {
            const difficulties = ['easy', 'medium', 'complex'];
            const currentLevelIndex = difficulties.indexOf(gameState.difficulty);

            if (currentLevelIndex < difficulties.length) {
                const nextLevel = difficulties[currentLevelIndex + 1];

                closeLevelCompletePopup();

                checkAttemptStatus(nextLevel);
            }
        };

        document.getElementById('btn-exit').onclick = () => {
            closeLevelCompletePopup();

            // Check if user is exiting after completing ALL levels 
            if (document.getElementById('btn-exit').textContent === 'View Leaderboard') {
                endGame(true); // Treat as final exit
                showLeaderboardScreen();
            } else {
                endGame(false); // Intermediate exit, allows overall timer to continue
                hideAllScreens();
                document.getElementById('game-container').style.display = 'block';
                initializeGame();
                document.getElementById('start-btn').disabled = false;
            }
        };

        document.getElementById('btn-go-to-leaderboard').onclick = () => {
            goToLeaderboardFromPopup();
        }

        document.getElementById('btn-try-low-level').onclick = () => {
            closeDemoCompletePopup();
            checkAttemptStatus('easy');
        };

        document.getElementById('btn-exit-demo').onclick = () => {
            closeDemoCompletePopup();
            initializeGame();
            showWelcomeScreen();
        };

        // Initial setup on window load
        window.onload = () => {
            setupLeaderboardListener();
            initializeGame();
            showWelcomeScreen();
        };
    </script>
</body>

</html>
